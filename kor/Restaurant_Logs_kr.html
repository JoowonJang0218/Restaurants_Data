<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>WhyCookIn 음식점 등록</title>
  <link rel="icon" href="logo.jpg" type="image/jpg">
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('siteLogo').style.cursor = 'pointer';
      document.getElementById('siteLogo').addEventListener('click', function() {
        window.location.href = 'index.html';
      });
    });
  </script>
  <link rel="stylesheet" href="styles.css"/>
  <!-- Kakao Maps JavaScript API (use your JS key, not REST key) -->
  <script 
    type="text/javascript" 
    src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=c8073a6f116f0517020b3c68e2f81487&libraries=services">
  </script>
</head>
<body>
  <header class="site-header">
    <img src="logo.jpg" alt="Site Logo" id="siteLogo">
    <h1>새 음식점 추가</h1>

    <!-- Button to switch to markdown_sales.html -->
    <button onclick="window.location.href='markdown_sales_kr.html'">
      마감 세일 등록 페이지로 이동
    </button>

    <!-- Language Switch -->
    <div class="language-switch">
      <button onclick="window.location.href='Restaurant_Logs.html'">ENG</button>
      <span>|</span>
      <button onclick="window.location.href='Restaurant_Logs_kr.html'">한국어</button>
    </div>
  </header>

  <!-- 지도 표시 -->
  <div id="map"></div>
  
  <!-- 검색 UI -->
  <div id="searchWrapper">
    <input type="text" id="keyword" placeholder="음식점 또는 주소 검색..." />
    <button onclick="searchPlaces()">검색</button>
  </div>
  
  <!-- 검색 결과 리스트 -->
  <ul id="placesList"></ul>
  
  <form id="restaurantForm">
    <fieldset>
      <legend>음식점 정보</legend>
      <p>
        <label for="name">이름</label>
        <input type="text" id="name" required />
      </p>
      <p>
        <label for="address">선택된 주소</label>
        <input type="text" id="address" required />
      </p>
    </fieldset>
    
    <fieldset>
      <legend>특징 (옵션)</legend>
      <div class="checkboxes">
        <label><input type="checkbox" id="english_speaking" /> 영어 가능</label>
        <label><input type="checkbox" id="vegan" /> 비건</label>
        <label><input type="checkbox" id="vegetarian" /> 베지테리언</label>
        <label><input type="checkbox" id="no_pork" /> 돼지고기 제외</label>
        <label><input type="checkbox" id="halal" /> 할랄</label>
        <label><input type="checkbox" id="no_beef" /> 소고기 제외</label>
        <label><input type="checkbox" id="gluten_free" /> 글루텐 프리</label>
        <label><input type="checkbox" id="allows_foreigners" /> 외국인 환영</label>
      </div>
    </fieldset>
    
    <button type="submit">서버에 등록</button>
  </form>
  
  <div id="message"></div>

<script>
// ---------------------------------------------------------------------------
// 1) 카카오 맵 초기화
// ---------------------------------------------------------------------------
var mapContainer = document.getElementById('map');
var mapOptions = { 
    center: new kakao.maps.LatLng(37.5665, 126.9780), // 기본 위치: 서울
    level: 5 // 줌 레벨
};
var map = new kakao.maps.Map(mapContainer, mapOptions); 

// 2) Kakao Places 준비
var ps = new kakao.maps.services.Places();  // 키워드 검색용
var markers = []; // 검색 결과 마커 배열

function searchPlaces() {
  var keyword = document.getElementById('keyword').value.trim();
  if (!keyword) {
    alert('검색어를 입력해주세요!');
    return;
  }
  // 카카오 키워드 검색
  ps.keywordSearch(keyword, placesSearchCB); 
}

function placesSearchCB(data, status, pagination) {
  if (status === kakao.maps.services.Status.OK) {
    displayPlaces(data);
  } else if (status === kakao.maps.services.Status.ZERO_RESULT) {
    alert('검색 결과가 없습니다.');
  } else {
    alert('검색 중 오류가 발생했습니다.');
  }
}

function displayPlaces(places) {
  clearMarkers();
  
  var listEl = document.getElementById('placesList');
  listEl.innerHTML = '';
  
  for (var i = 0; i < places.length; i++) {
    var place = places[i];
    var coords = new kakao.maps.LatLng(place.y, place.x);
    
    var marker = new kakao.maps.Marker({
      map: map,
      position: coords
    });
    markers.push(marker);
    
    kakao.maps.event.addListener(marker, 'click', function() {
      map.setCenter(this.getPosition());
    });
    
    var li = document.createElement('li');
    li.textContent = place.place_name + ' / ' + place.road_address_name;
    li.onclick = (function(pl, mk) {
      return function() {
        // 폼에 값 채우기
        document.getElementById('address').value = pl.road_address_name || pl.address_name;
        document.getElementById('name').value = pl.place_name; // 선택
        map.setCenter(mk.getPosition());
      };
    })(place, marker);
    
    listEl.appendChild(li);
  }
  
  // 지도 범위 맞추기
  var bounds = new kakao.maps.LatLngBounds();
  for (var j = 0; j < places.length; j++) {
    bounds.extend(new kakao.maps.LatLng(places[j].y, places[j].x));
  }
  map.setBounds(bounds);
}

function clearMarkers() {
  for (var i = 0; i < markers.length; i++) {
    markers[i].setMap(null);
  }
  markers = [];
}

// ---------------------------------------------------------------------------
// 3) 폼 전송 처리
// ---------------------------------------------------------------------------
document.getElementById('restaurantForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  var name = document.getElementById('name').value.trim();
  var address = document.getElementById('address').value.trim();

  var english_speaking = document.getElementById('english_speaking').checked;
  var vegan = document.getElementById('vegan').checked;
  var vegetarian = document.getElementById('vegetarian').checked;
  var no_pork = document.getElementById('no_pork').checked;
  var halal = document.getElementById('halal').checked;
  var no_beef = document.getElementById('no_beef').checked;
  var gluten_free = document.getElementById('gluten_free').checked;
  var allows_foreigners = document.getElementById('allows_foreigners').checked;

  if (!name || !address) {
    alert('지도에서 장소를 선택하거나 주소를 입력해주세요.');
    return;
  }
  
  // (1) DB에 이미 등록된 이름인지 확인
  let checkUrl = `https://restaurants-data-ax9v.onrender.com/api/restaurants?name=${encodeURIComponent(name)}`;
  
  try {
    const checkResponse = await fetch(checkUrl);
    if (checkResponse.ok) {
      const checkData = await checkResponse.json();
      if (checkData.exists) {
        // 이미 DB에 있다면 덮어쓸지 묻기
        let userConfirmed = confirm(`"${name}" 이미 등록된 음식점입니다. 정보를 덮어쓰시겠습니까?`);
        if (!userConfirmed) {
          return; // 취소 시 중단
        }
      }
    } else {
      console.warn('레스토랑 중복확인에서 오류 코드:', checkResponse.status);
      // 서버 오류 발생 시에도 POST 시도
    }
  } catch (err) {
    console.error('레스토랑 중복 확인 오류:', err);
    // 이 경우에도 POST 시도
  }

  // (2) 요청 바디 준비
  var requestBody = {
    name,
    address,
    english_speaking,
    vegan,
    vegetarian,
    no_pork,
    halal,
    no_beef,
    gluten_free,
    allows_foreigners
  };

  // (3) POST /api/restaurants
  try {
    const response = await fetch('https://restaurants-data-ax9v.onrender.com/api/restaurants', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(requestBody)
    });
    
    if (!response.ok) {
      let errorMsg = await response.text();
      throw new Error(errorMsg);
    }

    let result = await response.json();
    document.getElementById('message').style.color = 'green';
    document.getElementById('message').textContent =
      '음식점이 등록(업데이트)되었습니다. ID: ' + (result.id || '(알 수 없음)');
    
    // 폼 리셋
    this.reset();
    clearMarkers();
    document.getElementById('placesList').innerHTML = '';
  } catch (err) {
    console.error('오류:', err);
    document.getElementById('message').style.color = 'red';
    document.getElementById('message').textContent = '에러 발생: ' + err.message;
  }
});
</script>
</body>
</html>