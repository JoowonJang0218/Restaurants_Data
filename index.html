<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>WhyCookIn - Restaurant Filter</title>
  <link rel="icon" href="logo.jpg" type="image/jpg">
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('siteLogo').style.cursor = 'pointer';
      document.getElementById('siteLogo').addEventListener('click', function() {
        window.location.href = 'index.html';
      });
    });
  </script>
  <link rel="stylesheet" href="styles.css">

  <!-- Kakao Maps JavaScript API (JS Key) -->
  <script 
    type="text/javascript" 
    src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=c8073a6f116f0517020b3c68e2f81487&libraries=services">
  </script>
</head>
<body>
  <header class="site-header">
    <img src="logo.jpg" alt="Site Logo" id="siteLogo">
    <h1>Filter Restaurants</h1>
  </header>

    <!-- Map Display -->
    <div id="mapWrapper">
        <div id="map"></div>
    </div>

    <div id="message"></div>

    <!-- Filter UI -->
    <div class="filter" id="filterSection">
        <h2>Filter Restaurants</h2>
        <label for="filterName">Name contains:</label>
        <input type="text" id="filterName" placeholder="Partial name...">

        <div class="checkboxes">
        <label><input type="checkbox" id="filterHalal" /> Halal</label>
        <label><input type="checkbox" id="filterVegan" /> Vegan</label>
        <label><input type="checkbox" id="filterVegetarian" /> Vegetarian</label>
        <label><input type="checkbox" id="filterNoPork" /> No Pork</label>
        <label><input type="checkbox" id="filterNoBeef" /> No Beef</label>
        <label><input type="checkbox" id="filterGlutenFree" /> Gluten Free</label>
        <label><input type="checkbox" id="filterEnglish" /> English Speaking</label>
        <label><input type="checkbox" id="filterAllowsForeigners" /> Allows Foreigners</label>
        </div>
        
        <button onclick="loadFilteredRestaurants()">Apply Filters</button>
    </div>

<script>
// -----------------------------------------------------------------------------------
// 1) Initialize Kakao Map
// -----------------------------------------------------------------------------------
var mapContainer = document.getElementById('map');
var mapOptions = { 
    center: new kakao.maps.LatLng(37.5665, 126.9780), // Default: Seoul
    level: 5
};
var map = new kakao.maps.Map(mapContainer, mapOptions);

// We'll store markers in an array so we can clear them on each filter load
var markers = [];

// Simple function to clear existing markers
function clearMarkers() {
  for (let m of markers) {
    m.setMap(null);
  }
  markers = [];
}

// -----------------------------------------------------------------------------------
// 2) loadFilteredRestaurants()
//     - Gathers filters -> builds query -> calls /api/restaurants -> displays markers
// -----------------------------------------------------------------------------------
async function loadFilteredRestaurants() {
  try {
    // 1) Gather filters
    const nameInput = document.getElementById('filterName').value.trim();
    const halalChecked = document.getElementById('filterHalal').checked;
    const veganChecked = document.getElementById('filterVegan').checked;
    const vegetarianChecked = document.getElementById('filterVegetarian').checked;
    const noPorkChecked = document.getElementById('filterNoPork').checked;
    const noBeefChecked = document.getElementById('filterNoBeef').checked;
    const glutenFreeChecked = document.getElementById('filterGlutenFree').checked;
    const englishChecked = document.getElementById('filterEnglish').checked;
    const allowsForeignersChecked = document.getElementById('filterAllowsForeigners').checked;

    const bounds = map.getBountds();
    const sw = bounds.getSouthWest();       // sw.getLat(), sw.getLng()
    const ne = bounds.getNorthEast();      // ne.getLat(), ne.getLng()

    const minLat = sw.getLat();
    const minLon = sw.getLng();
    const maxLat = ne.getLat();
    const maxLon = ne.getLng();

    // 2) Build query params
    let params = [];
    if (nameInput) {
      params.push(`name=${encodeURIComponent(nameInput)}`);
    }
    if (halalChecked) params.push('halal=true');
    if (veganChecked) params.push('vegan=true');
    if (vegetarianChecked) params.push('vegetarian=true');
    if (noPorkChecked) params.push('no_pork=true');
    if (noBeefChecked) params.push('no_beef=true');
    if (glutenFreeChecked) params.push('gluten_free=true');
    if (englishChecked) params.push('english_speaking=true');
    if (allowsForeignersChecked) params.push('allows_foreigners=true');

    params.push(`minLat=${minLat}`);
    params.push(`maxLat=${maxLat}`);
    params.push(`minLon=${minLon}`);
    params.push(`maxLon=${maxLon}`);

    let queryString = '?' + params.join('&');
    let url = 'https://restaurants-data-ax9v.onrender.com/api/restaurants' + queryString;

    // 3) Fetch from your backend
    const res = await fetch(url);
    if (!res.ok) {
      throw new Error(`Server returned ${res.status} ${res.statusText}`);
    }
    const restaurants = await res.json();

    // 4) Clear old markers
    clearMarkers();

    // 5) Place new markers
    //    *IMPORTANT*: This code depends on your DB returning lat/lon fields. 
    //    If your DB stores geometry, you need to adapt the server to return them,
    //    e.g. SELECT ST_X(geom::geometry) as lon, ST_Y(geom::geometry) as lat, ...
    //    Then you can do: r.lat, r.lon. Otherwise, you'll see no markers.

    for (let r of restaurants) {
      if (!r.lat || !r.lon) {
        // If your server returns geometry differently, adapt
        continue;
      }
      const coords = new kakao.maps.LatLng(r.lat, r.lon);
      const marker = new kakao.maps.Marker({ map, position: coords });
      markers.push(marker);

      kakao.maps.event.addListener(marker, 'click', function() {
        map.setCenter(this.getPosition());
      });
    }

    document.getElementById('message').style.color = 'green';
    document.getElementById('message').textContent =
      `${restaurants.length} restaurant(s) found in current map area.`;

    // 6) Zoom map to markers
    if (markers.length > 0) {
      let bounds = new kakao.maps.LatLngBounds();
      for (let m of markers) {
        bounds.extend(m.getPosition());
      }
      map.setBounds(bounds);
    }

    document.getElementById('message').style.color = 'green';
    document.getElementById('message').textContent =
      `${restaurants.length} restaurant(s) found for current filter.`;

  } catch (err) {
    console.error('Error loading filtered restaurants:', err);
    document.getElementById('message').style.color = 'red';
    document.getElementById('message').textContent =
      'Error: ' + err.message;
  }
}
</script>

</body>
</html>