<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Restaurant</title>
  <link rel="icon" href="logo.jpg" type="image/jpg">
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Make the logo clickable
      document.getElementById('siteLogo').addEventListener('click', function() {
        window.location.href = 'index.html';
      });

      // Make the brand-title clickable
      document.getElementById('brandTitle').addEventListener('click', function() {
        window.location.href = 'index.html';
      });

      const menuBtn = document.getElementById('menuBtn');
      const navMenu = document.getElementById('navMenu');
      let showMenu = false;

      menuBtn.addEventListener('click', () => {
        if(!showMenu) {
          menuBtn.classList.add('open');
          navMenu.classList.add('show');
          showMenu = true;
        } else {
          menuBtn.classList.remove('open');
          navMenu.classList.remove('show');
          showMenu = false;
        }
      });

    });
  </script>
  <link rel="stylesheet" href="../styles.css"/>
  <!-- Kakao Maps JavaScript API (use your JS key, not REST key) -->
  <script 
    type="text/javascript" 
    src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=c8073a6f116f0517020b3c68e2f81487&libraries=services">
  </script>
</head>
<body>
  <header class="site-header">
    <img src="../logo.jpg" alt="WhyCookIn Logo" id="siteLogo">
    <h1 class="brand-title" id="brandTitle" style="cursor: pointer;">WhyCookIn<br>외쿸인</h1>

    <!-- Hamburger Menu Button -->
    <div class="menu-btn" id="menuBtn">
      <div class="menu-btn__burger"></div>
    </div>

    <nav class="nav-menu" id="navMenu">
      <ul>
        <li><a href="index.html">Back to Home</a></li>
        <li><a href="community.html">Community</a></li>
        <li><a href="Restaurant_Logs.html">Restaurants &amp; Cafes</a></li>
        <li><a href="markdown_sales.html">Markdown Sales</a></li>
        <li><a href="housing.html">Housing &amp; Legal Services</a></li>
      </ul>
    </nav>
  </header>

    <!-- Hero Section -->
    <section class="hero">
      <video autoplay muted loop playsinline id="heroVideo">
        <source src="../images/restaurants.mp4" type="video/mp4">
        Your browser does not support the video tag.
      </video>
    
      <div class="hero-content">
        <h1>Wanna go grab for something?</h1>
        <p>
          <strong>Search for a restaurant or address</strong> below, 
          select a place from the results, and fill in the form 
          to log the restaurant in our database.<br><br>
        </p>
        <p>
            <strong style="color: rgb(255, 84, 84);">Note: The founder is now off to the military from March 4, 2025 to September 3, 2026.</strong>
          The platform is currently under preparation and is crowd-sourcing the data.
        </p>
      </div>
    </section>

  <!-- Map Display -->
  <div id="map"></div>
  
  <!-- Search UI -->
  <div id="searchWrapper">
    <input type="text" id="keyword" placeholder="Search restaurant or address...">
    <button onclick="searchPlaces()">Search</button>
  </div>
  
  <!-- Results List -->
  <ul id="placesList"></ul>
  
  <form id="restaurantForm">
    <fieldset>
      <legend>Restaurant Info</legend>
      <p>
        <label for="name">Name</label>
        <input type="text" id="name" required />
      </p>
      <p>
        <label for="address">Selected Address</label>
        <input type="text" id="address" required />
      </p>
    </fieldset>
    
    <fieldset>
      <legend>Attributes</legend>
      <div class="checkboxes">
        <label><input type="checkbox" id="english_speaking" /> English Speaking</label>
        <label><input type="checkbox" id="vegan" /> Vegan</label>
        <label><input type="checkbox" id="vegetarian" /> Vegetarian</label>
        <label><input type="checkbox" id="no_pork" /> No Pork</label>
        <label><input type="checkbox" id="halal" /> Halal</label>
        <label><input type="checkbox" id="no_beef" /> No Beef</label>
        <label><input type="checkbox" id="gluten_free" /> Gluten Free</label>
        <label><input type="checkbox" id="allows_foreigners" /> Allows Foreigners</label>
      </div>
    </fieldset>
    
    <button type="submit">Submit to Server</button>
  </form>
  
  <div id="message"></div>

  <footer>
    <p>&copy; 2025 WhyCookIn. All rights reserved.</p>
  </footer>

<script>
// 1) Initialize Kakao Map
var mapContainer = document.getElementById('map');
var mapOptions = { 
    center: new kakao.maps.LatLng(37.5665, 126.9780), // Default center (Seoul)
    level: 5 // Zoom level
};
var map = new kakao.maps.Map(mapContainer, mapOptions); 

// 2) Prepare Kakao Places
var ps = new kakao.maps.services.Places();  // For keyword search
var markers = []; // hold search result markers

function searchPlaces() {
  var keyword = document.getElementById('keyword').value.trim();
  if (!keyword) {
    alert('Please enter a keyword!');
    return;
  }
  // Keyword search using Kakao's Places API
  ps.keywordSearch(keyword, placesSearchCB); 
}

function placesSearchCB(data, status, pagination) {
  if (status === kakao.maps.services.Status.OK) {
    displayPlaces(data);
  } else if (status === kakao.maps.services.Status.ZERO_RESULT) {
    alert('No search results found.');
  } else {
    alert('Error occurred during search.');
  }
}

function displayPlaces(places) {
  clearMarkers();
  
  var listEl = document.getElementById('placesList');
  listEl.innerHTML = '';
  
  for (var i = 0; i < places.length; i++) {
    var place = places[i];
    var coords = new kakao.maps.LatLng(place.y, place.x);
    
    var marker = new kakao.maps.Marker({
      map: map,
      position: coords
    });
    markers.push(marker);
    
    kakao.maps.event.addListener(marker, 'click', function() {
      map.setCenter(this.getPosition());
    });
    
    var li = document.createElement('li');
    li.textContent = place.place_name + ' / ' + place.road_address_name;
    li.onclick = (function(pl, mk) {
      return function() {
        // Fill the form fields
        document.getElementById('address').value = pl.road_address_name || pl.address_name;
        document.getElementById('name').value = pl.place_name; // optional
        map.setCenter(mk.getPosition());
      };
    })(place, marker);
    
    listEl.appendChild(li);
  }
  
  // Fit map to results
  var bounds = new kakao.maps.LatLngBounds();
  for (var j = 0; j < places.length; j++) {
    bounds.extend(new kakao.maps.LatLng(places[j].y, places[j].x));
  }
  map.setBounds(bounds);
}

function clearMarkers() {
  for (var i = 0; i < markers.length; i++) {
    markers[i].setMap(null);
  }
  markers = [];
}

// 3) Handle form submission
document.getElementById('restaurantForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  var name = document.getElementById('name').value.trim();
  var address = document.getElementById('address').value.trim();

  var english_speaking = document.getElementById('english_speaking').checked;
  var vegan = document.getElementById('vegan').checked;
  var vegetarian = document.getElementById('vegetarian').checked;
  var no_pork = document.getElementById('no_pork').checked;
  var halal = document.getElementById('halal').checked;
  var no_beef = document.getElementById('no_beef').checked;
  var gluten_free = document.getElementById('gluten_free').checked;
  var allows_foreigners = document.getElementById('allows_foreigners').checked;

  if (!name || !address) {
    alert('Please select a place or fill address');
    return;
  }
  
  // 3a) Check if restaurant with this name already exists
  let checkUrl = `https://restaurants-data-ax9v.onrender.com/api/restaurants?name=${encodeURIComponent(name)}`;
  
  try {
    const checkResponse = await fetch(checkUrl);
    if (checkResponse.ok) {
      const checkData = await checkResponse.json();
      if (checkData.exists) {
        // Already in DB
        let userConfirmed = confirm(`Someone else has already logged "${name}". Do you want to overwrite it?`);
        if (!userConfirmed) {
          // If user selects Cancel, stop here
          return;
        }
        // If user selects OK, continue on and POST 
      }
    } else {
      console.warn('Check for existing restaurant returned non-OK response:', checkResponse.status);
      // If there's a server error, proceed to attempt the POST anyway
    }
  } catch (err) {
    console.error('Error checking existing restaurant:', err);
    // If there's a fetch error, we proceed to attempt the POST anyway
  }

  // 3b) Build requestBody
  var requestBody = {
    name,
    address,
    english_speaking,
    vegan,
    vegetarian,
    no_pork,
    halal,
    no_beef,
    gluten_free,
    allows_foreigners
  };

  // 3c) POST to /api/restaurants
  try {
    const response = await fetch('https://restaurants-data-ax9v.onrender.com/api/restaurants', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(requestBody)
    });
    
    if (!response.ok) {
      let errorMsg = await response.text();
      throw new Error(errorMsg);
    }

    let result = await response.json();
    document.getElementById('message').style.color = 'green';
    document.getElementById('message').textContent = 'Restaurant added/updated with ID: ' + (result.id || '(unknown)');
    
    // Reset
    this.reset();
    clearMarkers();
    document.getElementById('placesList').innerHTML = '';
  } catch (err) {
    console.error('Error:', err);
    document.getElementById('message').style.color = 'red';
    document.getElementById('message').textContent = 'Error: ' + err.message;
  }
});
</script>
</body>
</html>