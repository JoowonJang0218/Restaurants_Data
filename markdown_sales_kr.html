<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>WhyCookIn - 마감 세일 등록</title>
  <link rel="icon" href="logo.jpg" type="image/jpg">
  <link rel="stylesheet" href="styles.css"/>

  <!-- Kakao Maps JavaScript API -->
  <script 
    type="text/javascript" 
    src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=c8073a6f116f0517020b3c68e2f81487&libraries=services">
  </script>
</head>
<body>
  <header class="site-header">
    <img src="logo.jpg" alt="Site Logo" id="siteLogo">
    <h1>마감 세일 등록</h1>

    <button onclick="window.location.href='Restaurant_Logs_kr.html'">
      레스토랑 등록 페이지로 이동
    </button>

    <div class="language-switch">
        <button onclick="window.location.href='markdown_sales.html'">ENG</button>
        <span>|</span>
        <button onclick="window.location.href='markdown_sales_kr.html'">한국어</button>
    </div>
  </header>

  <!-- 지도 표시 -->
  <div id="map"></div>
  
  <!-- 검색 UI -->
  <div id="searchWrapper">
    <input type="text" id="keyword" placeholder="가게 또는 주소를 검색하세요..." />
    <button onclick="searchPlaces()">검색</button>
  </div>
  
  <!-- 검색 결과 리스트 -->
  <ul id="placesList"></ul>
  
  <!-- DB에 가게가 없을 경우 안내 -->
  <div id="storePrompt" style="display: none;">
    <p>현재 이 상점(가게)이 데이터베이스에 없습니다. 새로 등록하시겠습니까?</p>
    <button onclick="showStoreForm()">네, 상점 추가</button>
    <button onclick="cancelStorePrompt()">아니오</button>
  </div>

  <!-- 상점 추가 폼 -->
  <form id="storeForm" style="display: none;" onsubmit="submitStoreForm(event)">
    <fieldset>
      <legend>새 상점(가게) 등록</legend>
      <p>
        <label for="storeName">상점 이름:</label>
        <input type="text" id="storeName" required />
      </p>
      <p>
        <label for="storeAddress">주소:</label>
        <input type="text" id="storeAddress" required />
      </p>
    </fieldset>
    <button type="submit">상점 저장</button>
  </form>

  <!-- 마감세일(할인 이벤트) 등록 폼 -->
  <form id="discountForm" style="display: none;" onsubmit="submitDiscountForm(event)">
    <fieldset>
      <legend>할인 정보 등록</legend>
      <input type="hidden" id="selectedStoreId" />

      <p>
        <label for="itemName">상품/메뉴 이름:</label>
        <input type="text" id="itemName" required />
      </p>
      <p>
        <label for="itemCategory">카테고리:</label>
        <input type="text" id="itemCategory" />
      </p>
      <p>
        <label for="reason">할인 사유:</label>
        <select id="reason">
          <option value="Near expiry">유통기한 임박</option>
          <option value="Damaged packaging">포장 파손</option>
          <option value="Overstock">재고 과잉</option>
          <option value="Poor Quality">품질 문제</option>
          <option value="Seasonal">시즈널(시즌상품)</option>
          <option value="Mislabeling">표기 오류</option>
          <option value="Returned by Customer">고객 반품</option>
          <option value="Promotion">프로모션</option>
          <option value="Other">기타</option>
        </select>
      </p>
      <p>
        <label for="originalPrice">원래 가격:</label>
        <input type="number" id="originalPrice" step="0.01" required />
      </p>
      <p>할인 가격이나 할인율 중 하나만 입력해주시면 나머지는 자동 계산됩니다.</p>
      <p>
        <label for="discountPrice">할인 가격:</label>
        <input type="number" id="discountPrice" step="0.01" />
      </p>
      <p>
        <label for="discountPercentage">할인율(%):</label>
        <input type="number" id="discountPercentage" step="0.01" />
      </p>
      <p>
        <label for="discountStart">할인 시작일시:</label>
        <input type="datetime-local" id="discountStart" />
      </p>
      <p>
        <label for="discountEnd">할인 종료일시:</label>
        <input type="datetime-local" id="discountEnd" />
      </p>
      <p>
        <label for="expirationDate">유통기한 (선택):</label>
        <input type="date" id="expirationDate" />
      </p>
      <p>
        <label for="quantity">수량:</label>
        <input type="number" id="quantity" />
      </p>

      <fieldset id="hoursContainer">
        <legend>해당 할인 운영 시간</legend>
        <div class="hoursRow">
          <label>시작:</label>
          <input type="time" class="startTime" />
          <label>종료:</label>
          <input type="time" class="endTime" />
          <button type="button" class="removeRowBtn" onclick="removeHoursRow(this)">X</button>
        </div>
      </fieldset>
      <button type="button" onclick="addHoursRow()">시간대 추가</button>

      <fieldset>
        <legend>식단 태그 (복수 선택 가능)</legend>
        <label><input type="checkbox" name="dietaryTag" value="vegan" /> 비건</label><br/>
        <label><input type="checkbox" name="dietaryTag" value="halal" /> 할랄</label><br/>
        <label><input type="checkbox" name="dietaryTag" value="vegetarian" /> 베지테리언</label><br/>
        <label><input type="checkbox" name="dietaryTag" value="no_pork" /> 돼지고기 제외</label><br/>
        <label><input type="checkbox" name="dietaryTag" value="no_beef" /> 소고기 제외</label><br/>
        <label><input type="checkbox" name="dietaryTag" value="gluten_free" /> 글루텐 프리</label><br/>
      </fieldset>
    </fieldset>
    <button type="submit">할인 등록</button>
  </form>

  <!-- 메시지 출력 영역 -->
  <div id="message"></div>

<script>
// ---------------------------------------------------------------------------
// 1) 카카오 맵 초기화
// ---------------------------------------------------------------------------
var mapContainer = document.getElementById('map');
var mapOptions = { 
    center: new kakao.maps.LatLng(37.5665, 126.9780), 
    level: 5
};
var map = new kakao.maps.Map(mapContainer, mapOptions); 

// 카카오 플레이스 검색
var ps = new kakao.maps.services.Places();  
var markers = [];

// ---------------------------------------------------------------------------
// 2) 검색 기능
// ---------------------------------------------------------------------------
function searchPlaces() {
  var keyword = document.getElementById('keyword').value.trim();
  if (!keyword) {
    alert('검색어를 입력해주세요!');
    return;
  }
  ps.keywordSearch(keyword, placesSearchCB);
}

function placesSearchCB(data, status, pagination) {
  if (status === kakao.maps.services.Status.OK) {
    displayPlaces(data);
  } else if (status === kakao.maps.services.Status.ZERO_RESULT) {
    alert('검색 결과가 없습니다.');
  } else {
    alert('검색 중 오류가 발생했습니다.');
  }
}

function displayPlaces(places) {
  clearMarkers();
  
  var listEl = document.getElementById('placesList');
  listEl.innerHTML = '';
  
  for (var i = 0; i < places.length; i++) {
    var place = places[i];
    var coords = new kakao.maps.LatLng(place.y, place.x);
    
    var marker = new kakao.maps.Marker({
      map: map,
      position: coords
    });
    markers.push(marker);
    
    kakao.maps.event.addListener(marker, 'click', function() {
      map.setCenter(this.getPosition());
    });
    
    var li = document.createElement('li');
    li.textContent = place.place_name + ' / ' + place.road_address_name;
    li.style.cursor = 'pointer';
    li.onclick = (function(pl) {
      return function() {
        map.setCenter(coords);
        onSelectPlace(pl);
      };
    })(place);
    
    listEl.appendChild(li);
  }
  
  // 결과에 맞게 맵 범위 재설정
  var bounds = new kakao.maps.LatLngBounds();
  for (var j = 0; j < places.length; j++){
    bounds.extend(new kakao.maps.LatLng(places[j].y, places[j].x));
  }
  map.setBounds(bounds);
}

function clearMarkers() {
  for (var i = 0; i < markers.length; i++) {
    markers[i].setMap(null);
  }
  markers = [];
}

// ---------------------------------------------------------------------------
// 시간대 추가/삭제
// ---------------------------------------------------------------------------
function addHoursRow() {
  const container = document.getElementById('hoursContainer');

  const newRow = document.createElement('div');
  newRow.classList.add('hoursRow');

  newRow.innerHTML = `
    <label>시작:</label>
    <input type="time" class="startTime" />
    <label>종료:</label>
    <input type="time" class="endTime" />
    <button type="button" class="removeRowBtn" onclick="removeHoursRow(this)">X</button>
  `;

  container.appendChild(newRow);
}

function removeHoursRow(buttonElement) {
  buttonElement.parentNode.remove();
}

// ---------------------------------------------------------------------------
// 3) 장소 선택 후 처리
// ---------------------------------------------------------------------------
var selectedPlace = null;

async function onSelectPlace(place) {
  selectedPlace = place; 
  // 가게가 DB에 있는지 확인
  const storeExists = await checkStoreExists(place.place_name);
  
  if (!storeExists) {
    document.getElementById('storePrompt').style.display = 'block';
    document.getElementById('storeName').value = place.place_name;
    document.getElementById('storeAddress').value = place.road_address_name || place.address_name;

  } else {
    document.getElementById('storePrompt').style.display = 'none';
    document.getElementById('storeForm').style.display = 'none';
    document.getElementById('discountForm').style.display = 'block';

    document.getElementById('selectedStoreId').value = storeExists.id;
    displayMessage('이미 등록된 상점입니다. 할인을 추가할 수 있습니다.', 'green');
  }
}

// DB에 상점이 있는지 확인 (예시)
async function checkStoreExists(storeName) {
  try {
    const response = await fetch(`https://restaurants-data-ax9v.onrender.com/api/stores?searchName=${encodeURIComponent(storeName)}`);
    if (!response.ok) {
      return false; 
    }
    const data = await response.json();
    if (data.exists) {
      return data; 
    } else {
      return false;
    }
  } catch (err) {
    console.error('상점 조회 오류:', err);
    return false;
  }
}

// ---------------------------------------------------------------------------
// 4) 상점 추가
// ---------------------------------------------------------------------------
function showStoreForm() {
  document.getElementById('storePrompt').style.display = 'none';
  document.getElementById('storeForm').style.display = 'block';
}

function cancelStorePrompt() {
  document.getElementById('storePrompt').style.display = 'none';
  displayMessage('상점을 추가하지 않았습니다. 다른 검색을 진행하세요.', 'red');
}

// 상점 저장
async function submitStoreForm(e) {
  e.preventDefault();
  
  const storeName = document.getElementById('storeName').value.trim();
  const storeAddress = document.getElementById('storeAddress').value.trim();
  
  if (!storeName || !storeAddress) {
    alert('상점 이름과 주소를 모두 입력해주세요.');
    return;
  }
  
  try {
    const response = await fetch('https://restaurants-data-ax9v.onrender.com/api/stores', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        store_name: storeName, 
        address: storeAddress
      })
    });

    if (!response.ok) {
      let errText = await response.text();
      throw new Error(errText);
    }

    const result = await response.json();
    displayMessage(`상점이 등록되었습니다. ID: ${result.id}`, 'green');

    document.getElementById('storeForm').style.display = 'none';
    document.getElementById('discountForm').style.display = 'block';
    document.getElementById('selectedStoreId').value = result.id;
    
  } catch (err) {
    console.error('상점 추가 오류:', err);
    displayMessage('상점 추가 오류: ' + err.message, 'red');
  }
}

// ---------------------------------------------------------------------------
// 5) 마감세일(할인 이벤트) 등록
// ---------------------------------------------------------------------------
async function submitDiscountForm(e) {
  e.preventDefault();
  
  const storeId = document.getElementById('selectedStoreId').value;
  if (!storeId) {
    alert('유효한 상점 정보가 없습니다.');
    return;
  }
  
  const itemName = document.getElementById('itemName').value.trim();
  const itemCategory = document.getElementById('itemCategory').value.trim();
  const reason = document.getElementById('reason').value;
  const originalPrice = parseFloat(document.getElementById('originalPrice').value);
  
  // 하나만 입력하면 됨(둘 다 입력 가능)
  const discountPrice = document.getElementById('discountPrice').value 
                        ? parseFloat(document.getElementById('discountPrice').value) 
                        : null;
  const discountPercentage = document.getElementById('discountPercentage').value
                            ? parseFloat(document.getElementById('discountPercentage').value)
                            : null;

  const discountStart = document.getElementById('discountStart').value;
  const discountEnd = document.getElementById('discountEnd').value;
  const expirationDate = document.getElementById('expirationDate').value;
  const quantity = document.getElementById('quantity').value 
                  ? parseInt(document.getElementById('quantity').value) 
                  : null;
  
  // 운영 시간
  const hoursRows = document.querySelectorAll('#hoursContainer .hoursRow');
  let allHours = [];
  hoursRows.forEach(row => {
    const startTime = row.querySelector('.startTime').value;
    const endTime   = row.querySelector('.endTime').value;
    if (startTime && endTime) {
      allHours.push(`${startTime}-${endTime}`);
    }
  });
  const discountHoursStr = allHours.join('; ');
  
  // 식단 태그
  const checkedBoxes = document.querySelectorAll('input[name="dietaryTag"]:checked');
  const dietaryTags = Array.from(checkedBoxes).map(cb => cb.value);

  try {
    const response = await fetch('https://restaurants-data-ax9v.onrender.com/api/discount-events', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        store_id: parseInt(storeId),
        item_name: itemName,
        item_category: itemCategory,
        reason: reason,
        original_price: originalPrice,
        discount_price: discountPrice,
        discount_percentage: discountPercentage,
        discount_start: discountStart ? new Date(discountStart).toISOString() : null,
        discount_end: discountEnd ? new Date(discountEnd).toISOString() : null,
        expiration_date: expirationDate || null,
        quantity: quantity,
        // item_image_url: null, // 필요 시 추가
        posted_by: null,
        store_hours: discountHoursStr,
        dietary_tags: dietaryTags,
        is_crowd_sourced: true,
        avg_rating: null,
        total_reviews: 0
      })
    });
    
    if (!response.ok) {
      let errText = await response.text();
      throw new Error(errText);
    }
    
    const result = await response.json();
    displayMessage(`할인 이벤트가 등록되었습니다. ID: ${result.id}`, 'green');
    
    e.target.reset();
    
  } catch (err) {
    console.error('할인 등록 오류:', err);
    displayMessage('할인 등록 오류: ' + err.message, 'red');
  }
}

// ---------------------------------------------------------------------------
// 6) 메시지 표시 함수
// ---------------------------------------------------------------------------
function displayMessage(msg, color) {
  const msgDiv = document.getElementById('message');
  msgDiv.style.color = color || 'black';
  msgDiv.textContent = msg;
}
</script>

</body>
</html>